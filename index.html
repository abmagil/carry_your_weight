<!DOCTYPE html>
<html>
<head>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<body>
  <div id="chart"></div>
  <script>
    //fake server
    subscribers = [];
    // subscribers.push();
    var commitDocument = function() {
      return {
        "commit": "bd2cbd1455df71765e9efb55ea17dd1cc545924f",
        "time": Date.now(),
        "author_lines": {
          "Liz": 4 + Math.floor((Math.random() * 10) +1 ),
          "Magil": 5 + Math.floor((Math.random() * 10) + 1)
        }
      }
    }
    setTimeout(function() {
      subscribers.forEach(function(e) {
        var event = new CustomEvent('getDocument', {detail: commitDocument});
        subscribers.forEach(function(elem) {
          elem.dispatchEvent(event)
        })
      })
    }, 1000);
  </script>
  <script>
  //client-side rendering
    subscribers.push(this)
    this.addEventListener('getDocument', function(e) {
      commitDetail = (e.detail.call().author_lines);
      var dataset = [];
      for (var person in commitDetail) {
        dataset.push({person: person, lines: commitDetail[person]});
      }
      console.log(dataset);
      var width = 360;
      var height = 360;
      var radius = Math.min(width, height) / 2;
      var color = d3.scale.ordinal().range(['#F75930', '#00AA75']);
      var svg = d3.select('#chart')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .append('g')
        .attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');
      var arc = d3.svg.arc().outerRadius(radius);
      var pie = d3.layout.pie()
        .value(function(d) {return d.lines;})
        .sort(null);
      var path = svg.selectAll('path')
        .data(pie(dataset))
        .enter()
        .append('path')
        .attr('d', arc)
        .attr('fill', function(d, i) {
          return color(d.data.name);
        });
    });
  </script>
</body>
</html>
